<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painting Pack Creator</title>
    <script src="https://unpkg.com/@tauri-apps/api/dist/index.iife.js"></script>
    <script src="https://unpkg.com/@tauri-apps/api/dist/dialog.iife.js"></script>

    <style>
        /* General body styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            background-color: #f4f7fa;
            color: #333;
        }

        /* Welcome screen styling */
        #welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            color: #777;
        }
        #welcome-screen h2 {
            font-size: 2em;
            font-weight: 500;
            color: #555;
        }
        #welcome-screen p {
            font-size: 1.2em;
        }

        /* Main content styling */
        #main-content {
            padding: 20px;
        }

        /* GLOBAL METADATA STYLING */
        #global-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            margin-bottom: 30px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            max-width: 1200px; 
            margin-left: auto;
            margin-right: auto;
        }

        #global-metadata input[type="text"] {
            flex-grow: 1;
            min-width: 200px; 
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
        }
        
        /* ROW METADATA STYLING */
        .row-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .row-metadata input[type="text"] {
            flex-grow: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* 1. Style for the main container */
        .grid-container {
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 15px;
            border: 2px solid #0056b3;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* CONTAINER FOR 5 IMAGES IN A ROW */
        .image-row-wrapper {
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 10px; 
            padding-bottom: 20px;
        }

        /* 2. Style for the individual items (The Cells) */
        .grid-item {
            background-color: #e6f7ff;
            border: 3px solid transparent; 
            border-radius: 4px;
            overflow: hidden; 
            position: relative;
            cursor: pointer; 
            transition: border-color 0.2s, background-color 0.2s; 
            aspect-ratio: 1 / 1; 
        }
        
        /* 3. Style for the actual image */
        .grid-item img {
            width: 100%;
            height: 100%;
            padding: 10px;
            object-fit: contain; 
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* 4. Checkmark Styling */
        .checkmark {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background-color: #10b981; 
            color: white;
            border-radius: 50%;
            display: none; 
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            line-height: 1;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            font-weight: bold;
        }
        
        /* 5. VISUAL FEEDBACK: Style when the item is selected */
        .grid-item.selected {
            border-color: #10b981; 
            background-color: #ccffeb; 
        }

        /* 6. SHOW the checkmark when the parent item is selected */
        .grid-item.selected .checkmark {
            display: flex; 
        }

        /* Media Query for Responsiveness */
        @media (max-width: 768px) {
             .image-row-wrapper {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <div id="welcome-screen">
        <h2>Painting Pack Creator</h2>
        <p>Import images to begin using <strong>File > Open Image(s)</strong></p>
    </div>

    <div id="main-content" style="display: none;">
        <div id="global-metadata">
            <input type="text" id="globalPackName" placeholder="Pack Name">
            <input type="text" id="globalVersion" placeholder="Version (e.g., 1.0.0)">
            <input type="text" id="globalId" placeholder="Unique ID (Auto-generated)">
            <input type="text" id="globalDescription" placeholder="Pack Description">
        </div>

        <div class="grid-container" id="dynamicGrid">
            </div>
    </div>

<script>
    const { invoke } = window.__TAURI__.core;
    const { listen } = window.__TAURI__.event;
    const { save } = window.__TAURI_PLUGIN_DIALOG__;

    const welcomeScreen = document.getElementById('welcome-screen');
    const mainContent = document.getElementById('main-content');
    const gridContainer = document.getElementById('dynamicGrid');

    // --- DEBOUNCE UTILITY ---
    function debounce(func, delay = 300) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // (The renderImageGrid function remains the same as before)
    function renderImageGrid(base64Images) {
        // ... function content ...
    }

    // --- GLOBAL EVENT LISTENERS ---

    // Listen for the 'Open' menu item
    listen('menu:open_file', async () => {
        // THIS IS THE KEY LOGGING STEP
        console.log("JavaScript received 'menu:open_file' event. Invoking Rust command...");
        try {
            const base64Images = await invoke('open_and_process_images');
            console.log("Rust command 'open_and_process_images' finished successfully.");
            
            if (base64Images && base64Images.length > 0) {
                welcomeScreen.style.display = 'none';
                mainContent.style.display = 'block';
                renderImageGrid(base64Images);
            }
        } catch (error) {
            // This will show any errors from the Rust command
            console.error("Error invoking 'open_and_process_images':", error);
        }
    });
    
    // Listen for the 'Export' menu item
    listen('menu:export_pack', async () => {
        // THIS IS THE KEY LOGGING STEP
        console.log("JavaScript received 'menu:export_pack' event. Invoking Rust command...");
        try {
            const exportPath = await save({
                title: "Save Painting Pack",
            });

            if (exportPath) {
                await invoke('export_pack', { exportPath });
                console.log("Rust command 'export_pack' finished successfully.");
                alert('Pack exported successfully!');
            }
        } catch (error) {
            // This will show any errors from the Rust command
            console.error("Error invoking 'export_pack':", error);
            alert(`Failed to export pack: ${error}`);
        }
    });

    // Debounced function to update global pack metadata in the backend
    const debouncedUpdatePack = debounce(() => {
        console.log("JavaScript invoking 'update_pack_metadata'");
        invoke('update_pack_metadata', {
            packName: document.getElementById('globalPackName').value,
            version: document.getElementById('globalVersion').value,
            id: document.getElementById('globalId').value,
            description: document.getElementById('globalDescription').value
        });
    });
    
    // Add event listeners to all global metadata fields
    document.getElementById('global-metadata').querySelectorAll('input').forEach(input => {
        input.addEventListener('input', debouncedUpdatePack);
    });

</script>

</body>
</html>